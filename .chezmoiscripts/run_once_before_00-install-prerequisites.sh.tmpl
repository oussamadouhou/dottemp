{{- if ne .chezmoi.os "windows" -}}
#!/usr/bin/env bash
# run_once_before_00-install-prerequisites.sh.tmpl

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}==> Installing prerequisites for {{ .osid }}${NC}"

{{ if eq .chezmoi.os "darwin" -}}
# macOS with Homebrew
if ! command -v brew &> /dev/null; then
    echo -e "${YELLOW}Installing Homebrew...${NC}"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Add Homebrew to PATH for this script
    {{ if eq .chezmoi.arch "arm64" -}}
    eval "$(/opt/homebrew/bin/brew shellenv)"
    {{ else -}}
    eval "$(/usr/local/bin/brew shellenv)"
    {{ end -}}
fi

echo -e "${GREEN}Installing packages via Homebrew...${NC}"
brew update
brew install \
    git \
    curl \
    wget \
    ripgrep \
    fd \
    bat \
    eza \
    neovim \
    starship \
    age \
    delta \
    fzf \
    jq \
    htop

{{ else if eq .osid "linux-arch" -}}
# Arch Linux
echo -e "${GREEN}Installing packages via pacman...${NC}"
sudo pacman -Syu --noconfirm --needed \
    git \
    curl \
    wget \
    base-devel \
    ripgrep \
    fd \
    bat \
    eza \
    neovim \
    starship \
    age \
    git-delta \
    fzf \
    jq \
    htop
sudo pacman -S --needed base-devel  \
    && git clone https://aur.archlinux.org/paru.git /tmp/paru \
    && cd /tmp/paru \
    && makepkg -si --noconfirm \
    && rm -rf /tmp/paru 

{{ else if or (eq .osid "linux-debian") (eq .osid "linux-ubuntu") -}}
# Debian/Ubuntu
echo -e "${GREEN}Installing packages via apt...${NC}"
sudo apt update
sudo apt install -y \
    git \
    curl \
    wget \
    build-essential \
    ripgrep \
    fd-find \
    bat \
    neovim \
    age \
    fzf \
    jq \
    htop

# Starship (not in standard repos)
if ! command -v starship &> /dev/null; then
    echo -e "${YELLOW}Installing starship...${NC}"
    curl -sS https://starship.rs/install.sh | sh -s -- -y
fi

# delta (not in standard repos for older versions)
if ! command -v delta &> /dev/null; then
    echo -e "${YELLOW}Installing delta...${NC}"
    DELTA_VERSION="0.17.0"
    DELTA_DEB="git-delta_${DELTA_VERSION}_amd64.deb"
    curl -sL "https://github.com/dandavison/delta/releases/download/${DELTA_VERSION}/${DELTA_DEB}" -o "/tmp/${DELTA_DEB}"
    sudo dpkg -i "/tmp/${DELTA_DEB}"
    rm "/tmp/${DELTA_DEB}"
fi

# eza (modern ls replacement)
if ! command -v eza &> /dev/null; then
    echo -e "${YELLOW}Installing eza...${NC}"
    sudo mkdir -p /etc/apt/keyrings
    wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
    echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | sudo tee /etc/apt/sources.list.d/gierens.list
    sudo chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/gierens.list
    sudo apt update
    sudo apt install -y eza
fi

{{ else -}}
echo -e "${YELLOW}Unknown Linux distribution: {{ .osid }}${NC}"
echo -e "${YELLOW}Please install prerequisites manually${NC}"
{{ end -}}

echo -e "${GREEN}==> Prerequisites installation complete!${NC}"
{{ end -}}
